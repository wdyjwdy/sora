---
title: 从零实现「Live Reload」
category: Blog
toc: true
---

## 工作原理

1. 监听文件变化
2. 重新编译文件（可选）
3. 页面自动刷新

## 从零实现

### 目录结构

```tree
demo
├── index.html
└── serve.ts
```

### 处理请求

- 工作原理：使用 serve 函数处理请求。
- 实现效果：访问 localhost:3000 后会看到 Hello。

```html
<h1>Hello</h1>
```

```ts
// 处理请求
Bun.serve({
  fetch(req) {
    const file = Bun.file("index.html", { type: "text/html" }); // 读取文件
    return new Response(file); // 响应文件
  },
});
```

### 监听文件变化

- 工作原理：使用 watch 函数监听文件变化。
- 实现效果：修改 index.html 并保存后，控制台打印 changed，手动刷新浏览器后会看到 Hello 123。

```html
<h1>Hello</h1>
```

```ts
import { watch } from "fs";

// 监听文件变化
watch("index.html", () => {
  console.log("changed");
});

Bun.serve({
  fetch(req) {
    const file = Bun.file("index.html", { type: "text/html" });
    return new Response(file);
  },
});
```

### 重新编译文件（可选）

有时候 index.html 是编译后得到的。当 index.md 变化时，需要重新转化。

```tree
demo
├── index.md
└── serve.ts
```

```ts
watch("index.html", async () => {
  await markdownToHtml("index.md");
});
```

### 页面自动刷新

- 工作原理：文件变化后，使用 WebSocket 通知浏览器刷新页面。
- 实现效果：访问 localhost:3000 后会看到 Hello，修改 index.html 并保存后，浏览器自动刷新，然后看到 Hello 123。

```html
<h1>Hello</h1>
<script>
  const ws = new WebSocket("ws://localhost:3000"); // 建立连接
  ws.onmessage = (event) => {
    if (event.data === "reload") location.reload(); // 刷新页面
  };
</script>
```

```ts
import { watch } from "fs";
import type { ServerWebSocket } from "bun";

let socket: ServerWebSocket;
watch("index.html", () => {
  socket.send("reload"); // 向浏览器发送信息
});

const server = Bun.serve({
  fetch(req) {
    if (server.upgrade(req)) return; // 开启 WebSocket
    const file = Bun.file("index.html", { type: "text/html" });
    return new Response(file);
  },
  websocket: {
    // 开启 WebSocket 的回调函数
    open(ws: ServerWebSocket) {
      socket = ws;
    },
    message() {},
  },
});
```
